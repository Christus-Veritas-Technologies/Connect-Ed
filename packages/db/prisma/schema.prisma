generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  LITE
  GROWTH
  ENTERPRISE
}

enum Role {
  ADMIN
  RECEPTIONIST
  TEACHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum FeeStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  ONLINE
}

enum PaymentType {
  SIGNUP_FEE
  TERM_PAYMENT
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum MessageType {
  EMAIL
  WHATSAPP
  SMS
}

enum ChatMessageType {
  TEXT
  EXAM_RESULT
  GRADE
  SUBJECT_INFO
}

enum MessageStatus {
  PENDING
  SENT
  FAILED
}

enum NotificationType {
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  STUDENT_ADDED
  TEACHER_ADDED
  FEE_OVERDUE
  MESSAGE_SENT
  SYSTEM_ALERT
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum StudentStatus {
  ACTIVE
  SUSPENDED
  ABSENT
}

enum SchoolPeriodType {
  TERM
  HOLIDAY
}

// ============================================
// MODELS
// ============================================

model School {
  id                 String   @id @default(cuid())
  name               String?
  plan               Plan     @default(LITE)
  isActive           Boolean  @default(false)
  signupFeePaid      Boolean  @default(false)
  onboardingComplete Boolean  @default(false)

  // Term and period management
  termlyFee         Decimal?         @db.Decimal(10, 2)
  currentTermNumber Int?
  currentTermYear   Int?
  termStartDate     DateTime?
  currentPeriodType SchoolPeriodType @default(TERM)
  holidayStartDate  DateTime?

  // Analytics
  studentCount Int?
  teacherCount Int?

  // School contact info
  address String?
  phone   String?
  email   String?
  website String?

  // Notification preferences
  notifyEmail    Boolean @default(true)
  notifyWhatsapp Boolean @default(true)
  notifySms      Boolean @default(true)
  notifyInApp    Boolean @default(true)

  // Messaging quotas (reset monthly)
  emailQuota     Int      @default(200)
  whatsappQuota  Int      @default(200)
  smsQuota       Int      @default(100)
  emailUsed      Int      @default(0)
  whatsappUsed   Int      @default(0)
  smsUsed        Int      @default(0)
  quotaResetDate DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  students       Student[]
  parents        Parent[]
  classes        Class[]
  subjects       Subject[]
  fees           Fee[]
  feePayments    FeePayment[]
  expenses       Expense[]
  schoolPayments SchoolPayment[]
  planPayments   PlanPayment[]
  intermediatePayments IntermediatePayment[]
  messageLogs    MessageLog[]
  notifications  Notification[]
  parentRequests ParentRequest[]
  onboardingProgress OnboardingProgress?
  announcements  Announcement[]
  grades         Grade[]
  exams          Exam[]

  @@map("schools")
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  password     String
  name         String
  phone        String?
  role         Role
  isActive     Boolean @default(true)
  tokenVersion Int     @default(0) // For refresh token invalidation
  onboardingComplete Boolean @default(true)

  // User preferences
  notifyInApp Boolean @default(true)
  notifyEmail Boolean @default(true)

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Teacher level (primary, secondary, or both)
  level String? // "primary", "secondary"

  // As class teacher
  classes Class[] @relation("ClassTeacher")

  // Classes this teacher teaches (subject assignments)
  classesTeaching TeacherClass[]

  // Subjects this teacher can teach
  teacherSubjects TeacherSubject[]

  // Recorded payments/expenses
  recordedPayments FeePayment[] @relation("ReceivedBy")
  recordedExpenses Expense[]    @relation("RecordedBy")
  
  // Payment records
  intermediatePayments IntermediatePayment[]
  
  // Notifications
  notifications Notification[]

  // Announcements
  createdAnnouncements Announcement[]        @relation("AnnouncementCreator")
  announcementComments AnnouncementComment[] @relation("AnnouncementComments")

  // Exams
  createdExams Exam[] @relation("ExamTeacher")

  @@index([schoolId])
  @@index([email])
  @@map("users")
}

model Student {
  id              String        @id @default(cuid())
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  gender          Gender?
  admissionNumber String
  admissionDate   DateTime      @default(now())
  status          StudentStatus @default(ACTIVE)
  isActive        Boolean       @default(true) // Deprecated, use status instead

  // Contact (optional, for direct student communication in Enterprise)
  email String?
  phone String?

  // Authentication (optional, for student portal access)
  password     String?
  tokenVersion Int     @default(0)
  onboardingComplete Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id], onDelete: SetNull)

  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id], onDelete: SetNull)

  fees           Fee[]
  parentRequests ParentRequest[]
  subjects       StudentSubject[]
  announcementComments AnnouncementComment[] @relation("StudentAnnouncementComments")
  examResults          ExamResult[]

  @@unique([schoolId, admissionNumber])
  @@index([schoolId])
  @@index([classId])
  @@index([parentId])
  @@map("students")
}

model Parent {
  id           String  @id @default(cuid())
  email        String  @unique
  password     String
  name         String
  phone        String?
  isActive     Boolean @default(true)
  tokenVersion Int     @default(0)
  onboardingComplete Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  children Student[]
  
  // Parent requests sent by this parent
  sentRequests     ParentRequest[] @relation("RequestingParent")
  // Parent requests received by this parent (as the existing parent)
  receivedRequests ParentRequest[] @relation("ExistingParent")
  
  // Announcement comments
  announcementComments AnnouncementComment[] @relation("ParentAnnouncementComments")

  @@index([schoolId])
  @@map("parents")
}

enum ParentRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model ParentRequest {
  id     String              @id @default(cuid())
  status ParentRequestStatus @default(PENDING)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  respondedAt DateTime?

  // Relations
  requestingParentId String
  requestingParent   Parent @relation("RequestingParent", fields: [requestingParentId], references: [id], onDelete: Cascade)

  existingParentId String
  existingParent   Parent @relation("ExistingParent", fields: [existingParentId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([requestingParentId])
  @@index([existingParentId])
  @@index([studentId])
  @@index([schoolId])
  @@index([status])
  @@map("parent_requests")
}

model Class {
  id       String  @id @default(cuid())
  name     String
  capacity Int?    // student capacity
  level    String? // primary, secondary
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classTeacherId String?
  classTeacher   User?   @relation("ClassTeacher", fields: [classTeacherId], references: [id], onDelete: SetNull)

  students Student[]
  subjects SubjectClass[]
  teachers TeacherClass[]
  exams    Exam[]

  // Chat
  chatMembers  ChatMember[]
  chatMessages ChatMessage[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("classes")
}

model Subject {
  id       String  @id @default(cuid())
  name     String
  code     String?
  level    String? // "primary" or "secondary"
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classes  SubjectClass[]
  students StudentSubject[]
  teacherClasses  TeacherClass[]  @relation("TeacherClassSubject")
  teacherSubjects TeacherSubject[] @relation("TeacherSubjectLink")
  grades          Grade[]
  exams           Exam[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("subjects")
}

model SubjectClass {
  id String @id @default(cuid())

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([subjectId, classId])
  @@map("subject_classes")
}

model StudentSubject {
  id String @id @default(cuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
  @@map("student_subjects")
}

// Teacher-Class assignment (which classes a teacher teaches and optionally which subject)
model TeacherClass {
  id String @id @default(cuid())

  teacherId String
  teacher   User @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  classId String
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  // Optional: the subject this teacher teaches in this class
  // If null, the teacher teaches all subjects (e.g., primary class teacher)
  subjectId String?
  subject   Subject? @relation("TeacherClassSubject", fields: [subjectId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([teacherId, classId, subjectId])
  @@index([teacherId])
  @@index([classId])
  @@index([subjectId])
  @@map("teacher_classes")
}

// Subjects a teacher is qualified to teach
model TeacherSubject {
  id String @id @default(cuid())

  teacherId String
  teacher   User @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("TeacherSubjectLink", fields: [subjectId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

model OnboardingProgress {
  id String @id @default(cuid())

  // School info (step 1)
  schoolName  String?
  address     String?
  phone       String?
  email       String?
  isLandline  Boolean?

  // Curriculum info (step 2)
  cambridge  Boolean?
  zimsec     Boolean?
  hasPrimary Boolean?
  hasSecondary Boolean?
  subjectsData Json? // Array of {name, level}

  // Classes info (step 3)
  classesData Json? // Array of {name, capacity, level}

  // Fee info (step 4)
  termlyFee Decimal? @db.Decimal(10, 2)

  // Term info (step 5)
  currentTermNumber Int?
  currentTermYear   Int?
  termStartMonth    Int?
  termStartDay      Int?

  // Grades info (step 6 - grades per subject)
  gradesData Json? // Array of { subjectName, grades: [{ name, minMark, maxMark, isPass }] }

  // Progress tracking
  currentStep Int @default(0)
  completedSteps Int[] @default([])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("onboarding_progress")
}

model Fee {
  id          String    @id @default(cuid())
  amount      Decimal   @db.Decimal(10, 2)
  description String
  dueDate     DateTime
  status      FeeStatus @default(PENDING)
  paidAmount  Decimal   @default(0) @db.Decimal(10, 2)
  paidAt      DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  payments FeePayment[]

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([dueDate])
  @@map("fees")
}

model FeePayment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  reference     String?
  notes         String?

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  feeId String
  fee   Fee    @relation(fields: [feeId], references: [id], onDelete: Cascade)

  receivedById String
  receivedBy   User   @relation("ReceivedBy", fields: [receivedById], references: [id])

  @@index([schoolId])
  @@index([feeId])
  @@map("fee_payments")
}

model Expense {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(10, 2)
  category    String
  description String
  date        DateTime
  receiptUrl  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  recordedById String
  recordedBy   User   @relation("RecordedBy", fields: [recordedById], references: [id])

  @@index([schoolId])
  @@index([date])
  @@index([category])
  @@map("expenses")
}

model SchoolPayment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  type          PaymentType
  status        PaymentStatus @default(PENDING)
  paymentMethod PaymentMethod
  reference     String? // Dodo session ID or manual reference
  periodStart   DateTime?
  periodEnd     DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([status])
  @@map("school_payments")
}

model PlanPayment {
  id                    String   @id @default(cuid())
  onceOffPaymentPaid    Boolean  @default(false)
  monthlyPaymentPaid    Boolean  @default(false)
  paid                  Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("plan_payments")
}

model IntermediatePayment {
  id        String   @id @default(cuid())
  amount    Decimal  @db.Decimal(10, 2)
  paid      Boolean  @default(false)
  plan      Plan
  reference String?  // PayNow transaction reference

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([schoolId])
  @@index([paid])
  @@map("intermediate_payments")
}

model MessageLog {
  id           String        @id @default(cuid())
  type         MessageType
  recipient    String
  subject      String?
  content      String?       @db.Text
  status       MessageStatus @default(PENDING)
  errorMessage String?
  sentAt       DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([type])
  @@index([createdAt])
  @@map("message_logs")
}

model Notification {
  id          String               @id @default(cuid())
  title       String
  message     String               @db.Text
  type        NotificationType
  priority    NotificationPriority @default(MEDIUM)
  isRead      Boolean              @default(false)
  readAt      DateTime?
  actionUrl   String?              // Optional URL to navigate to when clicked
  metadata    Json?                // Additional data related to the notification
  actorName   String?              // Name of the person who triggered the notification
  actorAvatar String?              // URL or initials for the actor's avatar

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([schoolId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// GRADES, EXAMS & RESULTS
// ============================================

enum ExamPaper {
  PAPER_1
  PAPER_2
  PAPER_3
  PAPER_4
  PAPER_5
}

model Grade {
  id      String  @id @default(cuid())
  name    String  // e.g. A, B, C, D, F
  minMark Int     // minimum mark (%) for this grade
  maxMark Int     // maximum mark (%) for this grade
  isPass  Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([subjectId])
  @@index([schoolId])
  @@map("grades")
}

model Exam {
  id    String    @id @default(cuid())
  name  String    // e.g. "Mid-Term Exam", "Final Exam"
  paper ExamPaper // Paper 1-5

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  classId String
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   User @relation("ExamTeacher", fields: [teacherId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  results ExamResult[]

  @@index([subjectId])
  @@index([classId])
  @@index([teacherId])
  @@index([schoolId])
  @@map("exams")
}

model ExamResult {
  id   String @id @default(cuid())
  mark Int    // percentage 0-100

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  examId String
  exam   Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@map("exam_results")
}

// ============================================
// CLASS CHAT
// ============================================

model ChatMember {
  id String @id @default(cuid())

  classId String
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  // Polymorphic member — exactly one of these is set
  memberType String // "USER" | "STUDENT" | "PARENT"
  memberId   String
  role       String // "ADMIN" | "TEACHER" | "STUDENT" | "PARENT"

  // Denormalized for fast display
  name   String
  avatar String?

  joinedAt DateTime @default(now())

  @@unique([classId, memberType, memberId])
  @@index([memberId, memberType])
  @@index([classId])
  @@map("chat_members")
}

model ChatMessage {
  id String @id @default(cuid())

  classId String
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  // Polymorphic sender
  senderType String // "USER" | "STUDENT" | "PARENT"
  senderId   String
  senderRole String // "ADMIN" | "TEACHER" | "STUDENT" | "PARENT"
  senderName String
  senderAvatar String?

  // Message content
  type     ChatMessageType @default(TEXT)
  content  String          @db.Text
  metadata Json?           // For primitives: { examId, studentId, subjectId, marks, grade, ... }

  // Privacy scoping — if set, only targetStudentId + their parents + admins + sender can see
  targetStudentId String?

  createdAt DateTime @default(now())

  @@index([classId, createdAt])
  @@index([targetStudentId])
  @@map("chat_messages")
}

// ============================================
// ANNOUNCEMENTS
// ============================================

enum AnnouncementLength {
  ONE_DAY
  ONE_WEEK
  ONE_MONTH
}

model Announcement {
  id         String             @id @default(cuid())
  heading    String             @db.VarChar(32)
  subheading String             @db.Text
  length     AnnouncementLength

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("AnnouncementCreator", fields: [createdById], references: [id], onDelete: Cascade)

  comments AnnouncementComment[]

  @@index([schoolId])
  @@index([createdAt])
  @@map("announcements")
}

model AnnouncementComment {
  id      String @id @default(cuid())
  content String @db.Text

  // Commenter info — one of these will be set
  userId    String?
  user      User?    @relation("AnnouncementComments", fields: [userId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    Parent?  @relation("ParentAnnouncementComments", fields: [parentId], references: [id], onDelete: Cascade)
  studentId String?
  student   Student? @relation("StudentAnnouncementComments", fields: [studentId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@index([announcementId])
  @@index([createdAt])
  @@map("announcement_comments")
}
